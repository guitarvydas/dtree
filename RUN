#!/bin/bash
# dtree
rm -f out.*
rm -f *.json
set -e
export SHELLOPTS
cd "$2"

PBPWD="$(pwd)"
fname="$1"
here="$2"
caller="$3"
./REFRESH-BOOTSTRAP

# push a new value of PBPWD onto the stack, which will get unwound to its previous value when this script ends
PBPWD="$(pwd)"

echo >>/tmp/pbplog.md
echo '@@@@@ dtree RUN @@@@@' >>/tmp/pbplog.md
for i in PBP PBPWD PBPCALLER caller PYTHONPATH fname
do
    echo "$i = ${!i}"  >>/tmp/pbplog.md
done
echo '@@@@@' >>/tmp/pbplog.md
echo >>/tmp/pbplog.md

${PBP}/das2json dtree-transmogrifier.drawio
echo '***  'python main.py "${PBPCALLER}/${fname}.drawio" main dtree-transmogrifier.drawio.json '|' ${PBP}/splitoutputs  >>/tmp/pbplog.md
python main.py "${PBPCALLER}/${fname}.drawio" main dtree-transmogrifier.drawio.json | ${PBP}/splitoutputs
if [ -f out.✗ ]
then
    echo
    echo ">> ERROR <<"
    cat out.✗
else
    mv out.frish "${PBPCALLER}/${fname}.frish"
    mv out.dt "${PBPCALLER}/${fname}.dt"
    mv out.py "${PBPCALLER}/${fname}.py"
    mv out.js "${PBPCALLER}/${fname}.js"
fi

